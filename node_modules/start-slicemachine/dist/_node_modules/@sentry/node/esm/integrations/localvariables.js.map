{"version":3,"file":"localvariables.js","sources":["../../../../../../../../node_modules/@sentry/node/esm/integrations/localvariables.js"],"sourcesContent":["import { _optionalChain } from '@sentry/utils/esm/buildPolyfills';\nimport { LRUMap } from 'lru_map';\n\n/**\n * Promise API is available as `Experimental` and in Node 19 only.\n *\n * Callback-based API is `Stable` since v14 and `Experimental` since v8.\n * Because of that, we are creating our own `AsyncSession` class.\n *\n * https://nodejs.org/docs/latest-v19.x/api/inspector.html#promises-api\n * https://nodejs.org/docs/latest-v14.x/api/inspector.html\n */\nclass AsyncSession  {\n\n  /** Throws is inspector API is not available */\n   constructor() {\n    /*\n    TODO: We really should get rid of this require statement below for a couple of reasons:\n    1. It makes the integration unusable in the SvelteKit SDK, as it's not possible to use `require`\n       in SvelteKit server code (at least not by default).\n    2. Throwing in a constructor is bad practice\n\n    More context for a future attempt to fix this:\n    We already tried replacing it with import but didn't get it to work because of async problems.\n    We still called import in the constructor but assigned to a promise which we \"awaited\" in\n    `configureAndConnect`. However, this broke the Node integration tests as no local variables\n    were reported any more. We probably missed a place where we need to await the promise, too.\n    */\n\n    // Node can be build without inspector support so this can throw\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const { Session } = require('inspector');\n    this._session = new Session();\n  }\n\n  /** @inheritdoc */\n   configureAndConnect(\n    onPause,\n    captureAll,\n  ) {\n    this._session.connect();\n    this._session.on('Debugger.paused', onPause);\n    this._session.post('Debugger.enable');\n    // We only want to pause on uncaught exceptions\n    this._session.post('Debugger.setPauseOnExceptions', { state: captureAll ? 'all' : 'uncaught' });\n  }\n\n  /** @inheritdoc */\n   async getLocalVariables(objectId) {\n    const props = await this._getProperties(objectId);\n    const unrolled = {};\n\n    for (const prop of props) {\n      if (_optionalChain([prop, 'optionalAccess', _ => _.value, 'optionalAccess', _2 => _2.objectId]) && _optionalChain([prop, 'optionalAccess', _3 => _3.value, 'access', _4 => _4.className]) === 'Array') {\n        unrolled[prop.name] = await this._unrollArray(prop.value.objectId);\n      } else if (_optionalChain([prop, 'optionalAccess', _5 => _5.value, 'optionalAccess', _6 => _6.objectId]) && _optionalChain([prop, 'optionalAccess', _7 => _7.value, 'optionalAccess', _8 => _8.className]) === 'Object') {\n        unrolled[prop.name] = await this._unrollObject(prop.value.objectId);\n      } else if (_optionalChain([prop, 'optionalAccess', _9 => _9.value, 'optionalAccess', _10 => _10.value]) || _optionalChain([prop, 'optionalAccess', _11 => _11.value, 'optionalAccess', _12 => _12.description])) {\n        unrolled[prop.name] = prop.value.value || `<${prop.value.description}>`;\n      }\n    }\n\n    return unrolled;\n  }\n\n  /**\n   * Gets all the PropertyDescriptors of an object\n   */\n   _getProperties(objectId) {\n    return new Promise((resolve, reject) => {\n      this._session.post(\n        'Runtime.getProperties',\n        {\n          objectId,\n          ownProperties: true,\n        },\n        (err, params) => {\n          if (err) {\n            reject(err);\n          } else {\n            resolve(params.result);\n          }\n        },\n      );\n    });\n  }\n\n  /**\n   * Unrolls an array property\n   */\n   async _unrollArray(objectId) {\n    const props = await this._getProperties(objectId);\n    return props\n      .filter(v => v.name !== 'length' && !isNaN(parseInt(v.name, 10)))\n      .sort((a, b) => parseInt(a.name, 10) - parseInt(b.name, 10))\n      .map(v => _optionalChain([v, 'optionalAccess', _13 => _13.value, 'optionalAccess', _14 => _14.value]));\n  }\n\n  /**\n   * Unrolls an object property\n   */\n   async _unrollObject(objectId) {\n    const props = await this._getProperties(objectId);\n    return props\n      .map(v => [v.name, _optionalChain([v, 'optionalAccess', _15 => _15.value, 'optionalAccess', _16 => _16.value])])\n      .reduce((obj, [key, val]) => {\n        obj[key] = val;\n        return obj;\n      }, {} );\n  }\n}\n\n/**\n * When using Vercel pkg, the inspector module is not available.\n * https://github.com/getsentry/sentry-javascript/issues/6769\n */\nfunction tryNewAsyncSession() {\n  try {\n    return new AsyncSession();\n  } catch (e) {\n    return undefined;\n  }\n}\n\n// Add types for the exception event data\n\n/** Could this be an anonymous function? */\nfunction isAnonymous(name) {\n  return name !== undefined && ['', '?', '<anonymous>'].includes(name);\n}\n\n/** Do the function names appear to match? */\nfunction functionNamesMatch(a, b) {\n  return a === b || (isAnonymous(a) && isAnonymous(b));\n}\n\n/** Creates a unique hash from stack frames */\nfunction hashFrames(frames) {\n  if (frames === undefined) {\n    return;\n  }\n\n  // Only hash the 10 most recent frames (ie. the last 10)\n  return frames.slice(-10).reduce((acc, frame) => `${acc},${frame.function},${frame.lineno},${frame.colno}`, '');\n}\n\n/**\n * We use the stack parser to create a unique hash from the exception stack trace\n * This is used to lookup vars when the exception passes through the event processor\n */\nfunction hashFromStack(stackParser, stack) {\n  if (stack === undefined) {\n    return undefined;\n  }\n\n  return hashFrames(stackParser(stack, 1));\n}\n\n/**\n * Adds local variables to exception frames\n */\nclass LocalVariables  {\n   static __initStatic() {this.id = 'LocalVariables';}\n\n    __init() {this.name = LocalVariables.id;}\n\n    __init2() {this._cachedFrames = new LRUMap(20);}\n\n   constructor(\n      _options = {},\n      _session = tryNewAsyncSession(),\n  ) {this._options = _options;this._session = _session;LocalVariables.prototype.__init.call(this);LocalVariables.prototype.__init2.call(this);}\n\n  /**\n   * @inheritDoc\n   */\n   setupOnce(addGlobalEventProcessor, getCurrentHub) {\n    this._setup(addGlobalEventProcessor, _optionalChain([getCurrentHub, 'call', _17 => _17(), 'access', _18 => _18.getClient, 'call', _19 => _19(), 'optionalAccess', _20 => _20.getOptions, 'call', _21 => _21()]));\n  }\n\n  /** Setup in a way that's easier to call from tests */\n   _setup(\n    addGlobalEventProcessor,\n    clientOptions,\n  ) {\n    if (this._session && _optionalChain([clientOptions, 'optionalAccess', _22 => _22.includeLocalVariables])) {\n      this._session.configureAndConnect(\n        ev => this._handlePaused(clientOptions.stackParser, ev ),\n        !!this._options.captureAllExceptions,\n      );\n\n      addGlobalEventProcessor(async event => this._addLocalVariables(event));\n    }\n  }\n\n  /**\n   * Handle the pause event\n   */\n   async _handlePaused(\n    stackParser,\n    { params: { reason, data, callFrames } },\n  ) {\n    if (reason !== 'exception' && reason !== 'promiseRejection') {\n      return;\n    }\n\n    // data.description contains the original error.stack\n    const exceptionHash = hashFromStack(stackParser, _optionalChain([data, 'optionalAccess', _23 => _23.description]));\n\n    if (exceptionHash == undefined) {\n      return;\n    }\n\n    const framePromises = callFrames.map(async ({ scopeChain, functionName, this: obj }) => {\n      const localScope = scopeChain.find(scope => scope.type === 'local');\n\n      // obj.className is undefined in ESM modules\n      const fn = obj.className === 'global' || !obj.className ? functionName : `${obj.className}.${functionName}`;\n\n      if (_optionalChain([localScope, 'optionalAccess', _24 => _24.object, 'access', _25 => _25.objectId]) === undefined) {\n        return { function: fn };\n      }\n\n      const vars = await _optionalChain([this, 'access', _26 => _26._session, 'optionalAccess', _27 => _27.getLocalVariables, 'call', _28 => _28(localScope.object.objectId)]);\n\n      return { function: fn, vars };\n    });\n\n    // We add the un-awaited promise to the cache rather than await here otherwise the event processor\n    // can be called before we're finished getting all the vars\n    this._cachedFrames.set(exceptionHash, Promise.all(framePromises));\n  }\n\n  /**\n   * Adds local variables event stack frames.\n   */\n   async _addLocalVariables(event) {\n    for (const exception of _optionalChain([event, 'optionalAccess', _29 => _29.exception, 'optionalAccess', _30 => _30.values]) || []) {\n      await this._addLocalVariablesToException(exception);\n    }\n\n    return event;\n  }\n\n  /**\n   * Adds local variables to the exception stack frames.\n   */\n   async _addLocalVariablesToException(exception) {\n    const hash = hashFrames(_optionalChain([exception, 'optionalAccess', _31 => _31.stacktrace, 'optionalAccess', _32 => _32.frames]));\n\n    if (hash === undefined) {\n      return;\n    }\n\n    // Check if we have local variables for an exception that matches the hash\n    // delete is identical to get but also removes the entry from the cache\n    const cachedFrames = await this._cachedFrames.delete(hash);\n\n    if (cachedFrames === undefined) {\n      return;\n    }\n\n    const frameCount = _optionalChain([exception, 'access', _33 => _33.stacktrace, 'optionalAccess', _34 => _34.frames, 'optionalAccess', _35 => _35.length]) || 0;\n\n    for (let i = 0; i < frameCount; i++) {\n      // Sentry frames are in reverse order\n      const frameIndex = frameCount - i - 1;\n\n      // Drop out if we run out of frames to match up\n      if (!_optionalChain([exception, 'optionalAccess', _36 => _36.stacktrace, 'optionalAccess', _37 => _37.frames, 'optionalAccess', _38 => _38[frameIndex]]) || !cachedFrames[i]) {\n        break;\n      }\n\n      if (\n        // We need to have vars to add\n        cachedFrames[i].vars === undefined ||\n        // We're not interested in frames that are not in_app because the vars are not relevant\n        exception.stacktrace.frames[frameIndex].in_app === false ||\n        // The function names need to match\n        !functionNamesMatch(exception.stacktrace.frames[frameIndex].function, cachedFrames[i].function)\n      ) {\n        continue;\n      }\n\n      exception.stacktrace.frames[frameIndex].vars = cachedFrames[i].vars;\n    }\n  }\n}LocalVariables.__initStatic();\n\nexport { LocalVariables };\n//# sourceMappingURL=localvariables.js.map\n"],"names":["LRUMap"],"mappings":"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","x_google_ignoreList":[0]}