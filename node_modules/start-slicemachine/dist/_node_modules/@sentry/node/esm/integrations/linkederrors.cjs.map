{"version":3,"file":"linkederrors.cjs","sources":["../../../../../../../../node_modules/@sentry/node/esm/integrations/linkederrors.js"],"sourcesContent":["import { _optionalChain } from '@sentry/utils/esm/buildPolyfills';\nimport { addGlobalEventProcessor, getCurrentHub } from '@sentry/core';\nimport { isInstanceOf, resolvedSyncPromise, SyncPromise } from '@sentry/utils';\nimport { exceptionFromError } from '../eventbuilder.js';\nimport { ContextLines } from './contextlines.js';\n\nconst DEFAULT_KEY = 'cause';\nconst DEFAULT_LIMIT = 5;\n\n/** Adds SDK info to an event. */\nclass LinkedErrors  {\n  /**\n   * @inheritDoc\n   */\n   static __initStatic() {this.id = 'LinkedErrors';}\n\n  /**\n   * @inheritDoc\n   */\n    __init() {this.name = LinkedErrors.id;}\n\n  /**\n   * @inheritDoc\n   */\n\n  /**\n   * @inheritDoc\n   */\n\n  /**\n   * @inheritDoc\n   */\n   constructor(options = {}) {LinkedErrors.prototype.__init.call(this);\n    this._key = options.key || DEFAULT_KEY;\n    this._limit = options.limit || DEFAULT_LIMIT;\n  }\n\n  /**\n   * @inheritDoc\n   */\n   setupOnce() {\n    addGlobalEventProcessor(async (event, hint) => {\n      const hub = getCurrentHub();\n      const self = hub.getIntegration(LinkedErrors);\n      const client = hub.getClient();\n      if (client && self && self._handler && typeof self._handler === 'function') {\n        await self._handler(client.getOptions().stackParser, event, hint);\n      }\n      return event;\n    });\n  }\n\n  /**\n   * @inheritDoc\n   */\n   _handler(stackParser, event, hint) {\n    if (!event.exception || !event.exception.values || !isInstanceOf(hint.originalException, Error)) {\n      return resolvedSyncPromise(event);\n    }\n\n    return new SyncPromise(resolve => {\n      void this._walkErrorTree(stackParser, hint.originalException , this._key)\n        .then((linkedErrors) => {\n          if (event && event.exception && event.exception.values) {\n            event.exception.values = [...linkedErrors, ...event.exception.values];\n          }\n          resolve(event);\n        })\n        .then(null, () => {\n          resolve(event);\n        });\n    });\n  }\n\n  /**\n   * @inheritDoc\n   */\n   async _walkErrorTree(\n    stackParser,\n    error,\n    key,\n    stack = [],\n  ) {\n    if (!isInstanceOf(error[key], Error) || stack.length + 1 >= this._limit) {\n      return Promise.resolve(stack);\n    }\n\n    const exception = exceptionFromError(stackParser, error[key]);\n\n    // If the ContextLines integration is enabled, we add source code context to linked errors\n    // because we can't guarantee the order that integrations are run.\n    const contextLines = getCurrentHub().getIntegration(ContextLines);\n    if (contextLines && _optionalChain([exception, 'access', _ => _.stacktrace, 'optionalAccess', _2 => _2.frames])) {\n      await contextLines.addSourceContextToFrames(exception.stacktrace.frames);\n    }\n\n    return new Promise((resolve, reject) => {\n      void this._walkErrorTree(stackParser, error[key], key, [exception, ...stack])\n        .then(resolve)\n        .then(null, () => {\n          reject();\n        });\n    });\n  }\n}LinkedErrors.__initStatic();\n\nexport { LinkedErrors };\n//# sourceMappingURL=linkederrors.js.map\n"],"names":["addGlobalEventProcessor","hub","getCurrentHub","isInstanceOf","resolvedSyncPromise","SyncPromise","exceptionFromError","ContextLines","_optionalChain"],"mappings":";;;;;;;;;AAMA,MAAM,cAAc;AACpB,MAAM,gBAAgB;AAGtB,MAAM,aAAc;AAAA;AAAA;AAAA;AAAA,EAIjB,OAAO,eAAe;AAAC,SAAK,KAAK;AAAA,EAAe;AAAA;AAAA;AAAA;AAAA,EAK/C,SAAS;AAAC,SAAK,OAAO,aAAa;AAAA,EAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAavC,YAAY,UAAU,CAAA,GAAI;AAAC,iBAAa,UAAU,OAAO,KAAK,IAAI;AACjE,SAAK,OAAO,QAAQ,OAAO;AAC3B,SAAK,SAAS,QAAQ,SAAS;AAAA,EAChC;AAAA;AAAA;AAAA;AAAA,EAKA,YAAY;AACXA,kCAAwB,OAAO,OAAO,SAAS;AAC7C,YAAMC,QAAMC,IAAAA;AACZ,YAAM,OAAOD,MAAI,eAAe,YAAY;AAC5C,YAAM,SAASA,MAAI;AACnB,UAAI,UAAU,QAAQ,KAAK,YAAY,OAAO,KAAK,aAAa,YAAY;AAC1E,cAAM,KAAK,SAAS,OAAO,WAAY,EAAC,aAAa,OAAO,IAAI;AAAA,MACjE;AACD,aAAO;AAAA,IACb,CAAK;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,SAAS,aAAa,OAAO,MAAM;AAClC,QAAI,CAAC,MAAM,aAAa,CAAC,MAAM,UAAU,UAAU,CAACE,gBAAa,KAAK,mBAAmB,KAAK,GAAG;AAC/F,aAAOC,YAAAA,oBAAoB,KAAK;AAAA,IACjC;AAED,WAAO,IAAIC,YAAW,YAAC,aAAW;AAChC,WAAK,KAAK,eAAe,aAAa,KAAK,mBAAoB,KAAK,IAAI,EACrE,KAAK,CAAC,iBAAiB;AACtB,YAAI,SAAS,MAAM,aAAa,MAAM,UAAU,QAAQ;AACtD,gBAAM,UAAU,SAAS,CAAC,GAAG,cAAc,GAAG,MAAM,UAAU,MAAM;AAAA,QACrE;AACD,gBAAQ,KAAK;AAAA,MACvB,CAAS,EACA,KAAK,MAAM,MAAM;AAChB,gBAAQ,KAAK;AAAA,MACvB,CAAS;AAAA,IACT,CAAK;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,eACL,aACA,OACA,KACA,QAAQ,CAAE,GACV;AACA,QAAI,CAACF,GAAY,aAAC,MAAM,GAAG,GAAG,KAAK,KAAK,MAAM,SAAS,KAAK,KAAK,QAAQ;AACvE,aAAO,QAAQ,QAAQ,KAAK;AAAA,IAC7B;AAED,UAAM,YAAYG,aAAAA,mBAAmB,aAAa,MAAM,GAAG,CAAC;AAI5D,UAAM,eAAeJ,IAAa,cAAA,EAAG,eAAeK,aAAY,YAAA;AAChE,QAAI,gBAAgBC,eAAc,eAAC,CAAC,WAAW,UAAU,OAAK,EAAE,YAAY,kBAAkB,QAAM,GAAG,MAAM,CAAC,GAAG;AAC/G,YAAM,aAAa,yBAAyB,UAAU,WAAW,MAAM;AAAA,IACxE;AAED,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,WAAK,KAAK,eAAe,aAAa,MAAM,GAAG,GAAG,KAAK,CAAC,WAAW,GAAG,KAAK,CAAC,EACzE,KAAK,OAAO,EACZ,KAAK,MAAM,MAAM;AAChB;MACV,CAAS;AAAA,IACT,CAAK;AAAA,EACF;AACH;AAAC,aAAa,aAAc;;","x_google_ignoreList":[0]}