import * as t from "io-ts"
import { withFallback } from "io-ts-types/lib/withFallback"

import { WidgetKey } from "../../../documents/widgets"
import NestableWidget from "../nestable/NestableWidget"
import { SlicesTypes } from "./SlicesTypes"

const IMAGE_PLACEHOLDER_URL =
	"https://images.prismic.io/slice-machine/621a5ec4-0387-4bc5-9860-2dd46cbc07cd_default_ss.png?auto=compress,format"

export const Variation = t.exact(
	t.intersection([
		t.type({
			id: t.string,
			name: t.string,
			description: t.string,
			imageUrl: withFallback(t.string, IMAGE_PLACEHOLDER_URL),
			docURL: t.string,
			version: t.string,
		}),
		t.partial({
			display: t.string,
			primary: t.record(WidgetKey, NestableWidget),
			items: t.record(WidgetKey, NestableWidget),
		}),
	]),
)

export type Variation = t.TypeOf<typeof Variation>

export const SharedSlice = t.exact(
	t.intersection([
		t.type({
			id: t.string,
			type: t.literal(SlicesTypes.SharedSlice),
			name: t.string,
			variations: t.readonlyArray(Variation),
		}),
		t.partial({
			description: t.string,
		}),
	]),
)

export type SharedSlice = t.TypeOf<typeof SharedSlice>
